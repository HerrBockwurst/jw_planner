<div id="CalendarAdmin_PatternAdder">
	<div id="CalendarAdmin_PatternAdderInner">
		<div class="headline">==calendaradmin NewPattern==</div>
		<div id="CalendarAdmin_PatternTimer">		
			<!-- From -->
			<div class="CalendarAdmin_PatternSpacer" style="margin-right: 20px;">
				<div style="font-size: 24px;">==common From==</div>
			</div>
			<div class="CalendarAdmin_PatternRow"><!-- From Time H -->
				<div>+</div>
				<div contentEditable="true" id="iCalendarAdminFromH">08</div>
				<div>-</div>
			</div>
			<div class="CalendarAdmin_PatternSpacer">
				<div>:</div>
			</div>
			<div class="CalendarAdmin_PatternRow"><!-- From Time M -->
				<div>+</div>
				<div contentEditable="true" id="iCalendarAdminFromM">00</div>
				<div>-</div>
			</div>
			<div class="CalendarAdmin_PatternSpacer" style="margin: 0px 20px;">
				<div style="font-size: 24px;">==common to==</div>
			</div>
			<!-- To -->
			<div class="CalendarAdmin_PatternRow"><!-- From Time H -->
				<div>+</div>
				<div contentEditable="true" id="iCalendarAdminToH">09</div>
				<div>-</div>
			</div>
			<div class="CalendarAdmin_PatternSpacer">
				<div>:</div>
			</div>
			<div class="CalendarAdmin_PatternRow"><!-- From Time M -->
				<div>+</div>
				<div contentEditable="true" id="iCalendarAdminToM">00</div>
				<div>-</div>
			</div>
			<div class="CalendarAdmin_PatternRow" style="margin-left: 60px;"><!-- From Time H -->
				<div style="width: 60px;">+</div>
				<div style="width: 60px;" contentEditable="true" id="iCalendarAdminCount">002</div>
				<div style="width: 60px;">-</div>
			</div>
			<div class="CalendarAdmin_PatternSpacer" style="margin-left:10px">
				<div style="font-size: 24px;">==common count==</div>
			</div>
			<br class="floatbreak" />
			<div style="margin-top: 10px;">
				<button>==calendaradmin AddPattern==</button>
				<button class="redbutton">==common back==</button>
			</div>
		</div>
	</div>
</div>
<script>
var toFocus;
var curDay;

$('.CalendarAdmin_PatternRow').children('div:not(:first-of-type):not(:last-of-type)').focusin(function(){
	var cell = this;
	var range, selection;
	if (document.body.createTextRange) {
		range = document.body.createTextRange();
		range.moveToElementText(cell);
		range.select();
	} else if (window.getSelection) {
		selection = window.getSelection();
		range = document.createRange();
		range.selectNodeContents(cell);
		selection.removeAllRanges();
		selection.addRange(range);
	}
});

$('.CalendarAdmin_PatternRow').children('div:first-of-type').click(function () {
	var Container = $(this).next();
	var Add = Container.is('#iCalendarAdminFromM') || Container.is('#iCalendarAdminToM') ? 15 : 1;
	var Limit = Container.is('#iCalendarAdminFromM') || Container.is('#iCalendarAdminToM') ? 59 : 23;
	var Int = parseInt(Container.text());
	
	if(Container.is('#iCalendarAdminCount')) Limit = 999;
	
	Int = Int + Add;
	
	if(Int > Limit) Int = 0;
	var NewText = Container.is('#iCalendarAdminCount') ? ("00" + Int).slice(-3) : ("0" + Int).slice(-2); 
	Container.text(NewText);
});

$('.CalendarAdmin_PatternRow').children('div:last-of-type').click(function() {
	var Container = $(this).prev();
	var Sub = Container.is('#iCalendarAdminFromM') || Container.is('#iCalendarAdminToM') ? 15 : 1;
	var Limit = Container.is('#iCalendarAdminCount') ? 1 : 0;
	var Int = parseInt(Container.text());
	var UnderZero = Container.is('#iCalendarAdminFromM') || Container.is('#iCalendarAdminToM') ? 45 : 23
	
	if(Container.is('#iCalendarAdminCount')) UnderZero = 1;
			
	Int = Int - Sub;
	
	
	if(Int < Limit) Int = UnderZero;
	var NewText = Container.is('#iCalendarAdminCount') ? ("00" + Int).slice(-3) : ("0" + Int).slice(-2); 
	Container.text(NewText);
});

$('.CalendarAdmin_PatternRow').children('div:not(:first-of-type):not(:last-of-type)').focusout(function(){
	  if($(this).is('#iCalendarAdminFromH') || $(this).is('#iCalendarAdminToH')) {
		  var Int = parseInt($(this).text());
		  if(isNaN(Int) || Int < 0 || Int > 23) {
			  toFocus = $(this);
			  displayMessageBox('==errors TimeFormat==', false, {}, function() {
				  toFocus.focus();
			  });
			  return;
		  }		 
		  $(this).text(('0' + Int).slice(-2));
	  } else if($(this).is('#iCalendarAdminFromM') || $(this).is('#iCalendarAdminToM')) {
		  var Int = parseInt($(this).text());
		  if(isNaN(Int) || Int < 0 || Int > 59) {
			  toFocus = $(this);
			  displayMessageBox('==errors TimeFormat==', false, {}, function() {
				  toFocus.focus();
			  });
			  return;
		  }
		  if(Int%15 != 0) {
			  if(Int < 8) Int = 0;
			  else if(Int >= 8 && Int < 23) Int = 15;
			  else if(Int >= 23 && Int < 38) Int = 30;
			  else Int = 45;
		  }
		  $(this).text(('0' + Int).slice(-2));
	  }
});

function CalendarAdmin_AddPattern() {
	var data = {
			fH : parseInt($('#iCalendarAdminFromH').text()),
			fM : parseInt($('#iCalendarAdminFromM').text()),
			tH : parseInt($('#iCalendarAdminToH').text()),
			tM : parseInt($('#iCalendarAdminToM').text()),
			count : parseInt($('#iCalendarAdminCount').text()),
			day : curDay,
			cid : $('#CalendarAdmin_CalSelect').val()
	};
	
	if(	data.fM%15 != 0 ||
		data.fM > 59 ||
		data.tM%15 != 0 ||
		data.tM > 59 ||
		data.fH > 23 ||
		data.tH > 23 ||
		data.fH < 0 ||
		data.tH < 0 ||
		isNaN(data.fH) || isNaN(data.fM) || isNaN(data.tH) || isNaN(data.tM) || isNaN(data.count) || isNaN(data.day) ) {
			displayMessageBox('==errors TimeFormat==');
			return;
	}
	
	displayLoadingBox();
	
	$.post('^PROTO^^HOME^/datahandler/calendaradmin/addPattern', data, function(data) {		
		testRedirect(data);
		if(!testJSON(data)) {
			hideLoadingBox();
			displayMessageBox('==errors formSubmit==', true);
			return;
		}
		if(testError(data, true, false)) {
			hideLoadingBox();
			return;
		}
		
		$('#CalendarAdmin_CalSelect').trigger('change');	
		hideLoadingBox();		
	});
}

function CalendarAdmin_CloseOverlay() {	
	$('#CalendarAdmin_PatternAdder').fadeOut(100);
}

$('#CalendarAdmin_PatternAdder').find('button').click(function() {
	if($(this).hasClass('redbutton')) CalendarAdmin_CloseOverlay();
	else CalendarAdmin_AddPattern();
})
</script>